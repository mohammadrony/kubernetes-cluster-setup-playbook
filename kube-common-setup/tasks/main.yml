---
- name: Disable SELinux on reboot
  selinux:
    state: disabled

- name: Disable SELinux on current session
  command: setenforce 0

- name: Install firewalld package
  yum:
    name: firewalld
    state: present

- name: Disable firewall service for labs
  service:
    name: firewalld
    state: stopped
    enabled: false

- name: Enable kernel module
  copy:
    src: files/module-k8s.conf
    dest: /etc/modules-load.d/k8s.conf
    owner: root
    group: root
    mode: "0644"

- name: Enable kernal module command
  shell: |
    modprobe overlay
    modprobe br_netfilter

- name: Letting iptables see bridged traffic
  copy:
    src: files/network-k8s.conf
    dest: /etc/sysctl.d/k8s.conf
    owner: root
    group: root
    mode: "0644"

- name: Reload sysctl config for iptables
  command: sysctl --system

- name: Disable SWAP
  shell: |
    swapoff -a

- name: Disable SWAP in fstab
  lineinfile:
    path: /etc/fstab
    regexp: "swap"
    state: absent

- name: Install dnf-utils
  yum:
    name:
      - yum-utils
      - iproute-tc
    state: present
    update_cache: true

- name: Remove runc
  yum:
    name: runc
    state: absent

- name: Add Docker repository
  shell: dnf config-manager --add-repo=https://download.docker.com/linux/centos/docker-ce.repo

- name: install containerd.io
  yum:
    name: containerd.io
    state: present
    update_cache: true

- name: Backup containerd config.toml
  command: mv /etc/containerd/config.toml /etc/containerd/config.toml.orig

- name: Generate default containerd config.toml
  shell: containerd config default > /etc/containerd/config.toml

- name: Modify containerd config.toml
  replace:
    path: /etc/containerd/config.toml
    regexp: '^(\s*SystemdCgroup =) false'
    replace: '\1 true'
    backup: yes

- name: Add kubernetes repository source
  copy:
    src: files/repo-k8s.repo
    dest: /etc/yum.repos.d/kubernetes.repo
    owner: root
    group: root
    mode: "0644"

- name: Add text block to file
  blockinfile:
    path: /etc/containerd/config.toml
    block: |
      [host."https://registryserver.ieims.local"]
      capabilities = ["pull", "resolve"]
      ca = "/etc/containerd/certs.d/registryserver.ieims.local/ca.crt"
    marker: "# START ANSIBLE MANAGED BLOCK"

- name: Creates directory
  ansible.builtin.file:
    path: /etc/containerd/certs.d/registryserver.ieims.local/
    state: directory

- name: Update certificates for harbor server
  copy:
    src: files/ca.crt
    dest: /etc/containerd/certs.d/registryserver.ieims.local/ca.crt
    owner: root
    group: root
    mode: "0644"

- name: start containerd
  service:
    name: containerd
    state: restarted
    enabled: true

- name: Update repository cache
  dnf:
    name: "*"
    state: latest

- name: Install kubelet, kubeadm
  dnf:
    name:
      - kubelet
      - kubeadm
    disable_excludes: kubernetes
    state: latest
    update_cache: true

- name: Start Kubelet
  service:
    name: kubelet
    enabled: yes
    state: started
# - name: reboot ALL machines
#   reboot:
